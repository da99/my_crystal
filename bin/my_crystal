#!/usr/bin/env mksh
#
#
set -u -e -o pipefail
local +x THE_ARGS="$@"
local +x THIS_DIR="$(dirname "$(dirname "$0")")"

PATH="$PATH:$THIS_DIR/progs/latest-crystal/bin"
PATH="$PATH:$THIS_DIR/bin"

local +x ACTION="[none]"
if [[ ! -z "$@" ]]; then
  ACTION="$1"; shift
fi

export SHARDS_INSTALL_PATH="$PWD/.shards/.install"
export CRYSTAL_PATH="$PWD/.shards/.install:$THIS_DIR/progs/latest-crystal/src"

case $ACTION in

  help|--help|-h)
    PATH="$PATH:$THIS_DIR/../mksh_setup/bin"
    mksh_setup print-help $0 "$@"
    ;;

  *)
    local +x SH_FILE="$THIS_DIR/sh/${ACTION}/_"
    if [[ -s  "$SH_FILE"  ]]; then
      source "$SH_FILE"
      exit 0
    fi

    # === Check progs/bin:
    local +x BIN_FILE="$THIS_DIR/progs/bin/${ACTION}.sh"
    if [[ -x "$BIN_FILE" ]]; then
      export PATH="$THIS_DIR/progs/bin:$PATH"
      "$BIN_FILE" "$@"
      exit 0
    fi

    # === Send it to crystal:
    crystal "$ACTION" "$@"
    exit 0

    # === It's an error:
    echo "!!! Unknown action: $ACTION" 1>&2
    exit 1
    ;;

esac
