#!/usr/bin/env mksh
#
#
set -u -e -o pipefail
local +x THE_ARGS="$@"
local +x THIS_DIR="$(dirname "$(dirname "$0")")"

PATH="$PATH:$THIS_DIR/tmp/latest-crystal/bin"
PATH="$PATH:$THIS_DIR/bin"
PATH="$PATH:$THIS_DIR/../my_os/bin"

local +x ACTION="[none]"
if [[ ! -z "$@" ]]; then
  ACTION="$1"; shift
fi

local +x CRYSTAL_VERSION_FILE="$THIS_DIR/configs/crystal-version"
export SHARDS_INSTALL_PATH="$PWD/.shards/.install"
export CRYSTAL_VERSION="${CRYSTAL_VERSION:=""}"

if [[ -z "$CRYSTAL_VERSION" ]]; then
  CRYSTAL_VERSION="$(cat "$CRYSTAL_VERSION_FILE")"
fi

export CRYSTAL_PATH="$PWD/.shards/.install:$THIS_DIR/tmp/latest-crystal/src"

if [[ "$(arch)" != "x86_64" ]]; then
  echo "!!! Only 64-bit architecures supported." >&2
  echo "!!! (Only 512 fibers allowed in 32-bit architectures.)" >&2
  exit 2
fi

case $ACTION in

  help|--help|-h)
    PATH="$PATH:$THIS_DIR/../mksh_setup/bin"
    mksh_setup print-help $0 "$@"
    ;;

  *)
    local +x SH_FILE="$THIS_DIR/sh/${ACTION}/_"
    if [[ -s  "$SH_FILE"  ]]; then
      source "$SH_FILE"
      exit 0
    fi

    # === Check tmp/bin:
    local +x BIN_FILE="$THIS_DIR/tmp/bin/${ACTION}.sh"
    if [[ -x "$BIN_FILE" ]]; then
      export PATH="$THIS_DIR/tmp/bin:$PATH"
      "$BIN_FILE" "$@"
      exit 0
    fi

    # === Send it to crystal:
    crystal "$ACTION" "$@"
    exit 0

    # === It's an error:
    echo "!!! Unknown action: $ACTION" 1>&2
    exit 1
    ;;

esac
